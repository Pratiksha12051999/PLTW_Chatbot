version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
      python: 3.11
    commands:
      - echo "ğŸ“¦ Installing dependencies..."
      - npm install -g aws-cdk
      - yum install -y jq
      - cd backend && npm install && cd ..
      - cd backend/cdk && npm install && cd ../..
      - cd frontend && npm install && cd ..

  pre_build:
    commands:
      - echo "ğŸ”§ Pre-build phase started"
      - aws sts get-caller-identity
      - export CDK_DEFAULT_ACCOUNT=${AWS_ACCOUNT}
      - export CDK_DEFAULT_REGION=${AWS_REGION}
      - |
        if [ "$ACTION" = "deploy" ]; then
          cd backend
          npm run build || echo "Build had errors"
          rm -rf lambda-bundle
          mkdir -p lambda-bundle
          cp -r dist/* lambda-bundle/
          cp package.json lambda-bundle/
          cd lambda-bundle
          npm install --production --omit=dev
          cd ../..
          cd backend/cdk
          npx tsc
          cd ../..
        fi

  build:
    commands:
      - cd backend/cdk
      - |
        if [ "$ACTION" = "deploy" ]; then
          cdk bootstrap aws://${AWS_ACCOUNT}/${AWS_REGION}
          cdk synth --context environment=${ENVIRONMENT} --context bedrockAgentId=${BEDROCK_AGENT_ID} --context bedrockAgentAliasId=${BEDROCK_AGENT_ALIAS_ID} --context region=${AWS_REGION}
          cdk deploy --all --require-approval never --context environment=${ENVIRONMENT} --context bedrockAgentId=${BEDROCK_AGENT_ID} --context bedrockAgentAliasId=${BEDROCK_AGENT_ALIAS_ID} --context region=${AWS_REGION} --outputs-file ../../cdk-outputs.json
        fi
      - cd ../..
      - |
        if [ "$ACTION" = "deploy" ] && [ -f "cdk-outputs.json" ]; then
          echo "ğŸ“‹ CDK Outputs:"
          cat cdk-outputs.json
          echo ""
          WS_URL=$(jq -r '.WebSocketStack.WebSocketURL' cdk-outputs.json 2>/dev/null || jq -r '.WebSocketStack.WebSocketApiUrl' cdk-outputs.json 2>/dev/null || echo "")
          API_URL=$(jq -r '.RestApiStack.RestApiUrl' cdk-outputs.json 2>/dev/null || jq -r '.RestApiStack.PLTWRestApiEndpoint98DE8254' cdk-outputs.json 2>/dev/null || echo "")
          BUCKET=$(jq -r '.FrontendStack.FrontendBucketName' cdk-outputs.json 2>/dev/null || echo "")
          DIST_ID=$(jq -r '.FrontendStack.CloudFrontDistributionId' cdk-outputs.json 2>/dev/null || echo "")
          POOL_ID=$(jq -r '.CognitoStack.UserPoolId' cdk-outputs.json 2>/dev/null || echo "")
          CLIENT_ID=$(jq -r '.CognitoStack.UserPoolClientId' cdk-outputs.json 2>/dev/null || echo "")
          echo "WebSocket: ${WS_URL}"
          echo "REST API: ${API_URL}"
          echo "Cognito Pool: ${POOL_ID}"
          if [ -n "$BUCKET" ]; then
            echo "ğŸ“ Updating root .env with frontend config..."
            if [ -f ".env" ]; then
              echo "Current .env before update:"
              cat .env
              sed -i '/^NEXT_PUBLIC_/d' .env
            else
              touch .env
            fi
            echo "" >> .env
            echo "# Frontend Configuration (Auto-generated)" >> .env
            echo "NEXT_PUBLIC_ENVIRONMENT=${ENVIRONMENT}" >> .env
            echo "NEXT_PUBLIC_REGION=${AWS_REGION}" >> .env
            echo "NEXT_PUBLIC_WEBSOCKET_URL=${WS_URL}" >> .env
            echo "NEXT_PUBLIC_API_URL=${API_URL}" >> .env
            echo "NEXT_PUBLIC_REST_API_URL=${API_URL}" >> .env
            echo "NEXT_PUBLIC_USER_POOL_ID=${POOL_ID}" >> .env
            echo "NEXT_PUBLIC_USER_POOL_CLIENT_ID=${CLIENT_ID}" >> .env
            echo "NEXT_PUBLIC_DEBUG=false" >> .env
            echo ""
            echo "âœ… Updated root .env:"
            cat .env
            echo ""
            echo "ğŸ“‹ Copying to frontend/.env..."
            cp .env frontend/.env
            echo "âœ… Frontend .env:"
            cat frontend/.env
            echo ""
            echo "ğŸ§¹ Cleaning build artifacts..."
            rm -rf frontend/.next
            rm -rf frontend/out
            rm -rf frontend/build
            cd frontend
            echo "ğŸ—ï¸  Building frontend..."
            npm run build
            BUILD_DIR=""
            if [ -d "out" ]; then
              BUILD_DIR="out"
            elif [ -d "build" ]; then
              BUILD_DIR="build"
            fi
            if [ -z "$BUILD_DIR" ]; then
              echo "âŒ No build output"
              exit 1
            fi
            echo "â˜ï¸  Uploading to S3..."
            aws s3 sync ${BUILD_DIR}/ s3://${BUCKET}/ --delete
            if [ -n "$DIST_ID" ]; then
              echo "ğŸ”„ Invalidating CloudFront..."
              aws cloudfront create-invalidation --distribution-id "${DIST_ID}" --paths "/*"
            fi
            cd ..
            echo "âœ… Frontend deployed"
          fi
        fi

  post_build:
    commands:
      - |
        if [ "$ACTION" = "deploy" ] && [ -f "cdk-outputs.json" ]; then
          echo "ğŸ‰ DEPLOYMENT COMPLETE"
          FRONTEND_URL=$(jq -r '.FrontendStack.FrontendUrl' cdk-outputs.json 2>/dev/null || echo "")
          WEBSOCKET_URL=$(jq -r '.WebSocketStack.WebSocketURL' cdk-outputs.json 2>/dev/null || echo "")
          REST_API_URL=$(jq -r '.RestApiStack.RestApiUrl' cdk-outputs.json 2>/dev/null || echo "")
          echo "ğŸ–¥ï¸  Frontend: ${FRONTEND_URL}"
          echo "ğŸ”Œ WebSocket: ${WEBSOCKET_URL}"
          echo "ğŸ”— REST API: ${REST_API_URL}"
          jq '.' cdk-outputs.json
        fi

artifacts:
  files:
    - "**/*"

cache:
  paths:
    - "backend/node_modules/**/*"
    - "backend/cdk/node_modules/**/*"
    - "frontend/node_modules/**/*"
